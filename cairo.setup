;;;; -*- Scheme -*-
(use srfi-1)
(use srfi-13)

;;; on some systems cairo is compiled with pthread support using the
;;; option '-pthread'. We need to parse the pkgconfig output to prefix
;;; any non-include directives with '-C' so that csc passes them through
;;; to the c-compiler.
(define mark-compiler-options 
  (lambda (m s)
    (reduce (lambda (s1 s2) (string-append s1 " " s2))
	    ""
	    (map (lambda (option)
		   (if (string-prefix? "-I" option)
		       option
		       (string-append m " " option)))
		 (string-tokenize s)))))

(let ((pkg-cflags (mark-compiler-options "-C" (with-input-from-pipe "pkg-config --cflags cairo" read-line)))
      (pkg-lflags (mark-compiler-options "-L" (with-input-from-pipe "pkg-config --libs cairo" read-line))))
  (compile -s -O2 -ot cairo.types cairo.scm -J ,pkg-cflags ,pkg-lflags)
  (compile -debug M -c -O2 cairo.scm -J -unit cairo ,pkg-cflags ,pkg-lflags)
  
  (compile -s -O2 cairo.svg.scm -J ,pkg-cflags ,pkg-lflags)
  (compile -debug M -c -O2 cairo.svg.scm -J -o cairo.svg.o -unit cairo.svg ,pkg-cflags ,pkg-lflags)
  
  (compile -s -O2 cairo.image.scm -J ,pkg-cflags ,pkg-lflags)
  (compile -debug M -c -O2 cairo.image.scm -J -o cairo.image.o -unit cairo.image ,pkg-cflags ,pkg-lflags)
  
  (compile -s -O2 cairo.xlib.scm -J ,pkg-cflags ,pkg-lflags -lX11)
  (compile -debug M -c -O2 cairo.xlib.scm -J -o cairo.xlib.o -unit cairo.xlib ,pkg-cflags ,pkg-lflags)
  
  (compile -s -O2 cairo.import.scm)
  (compile -s -O2 cairo.svg.import.scm)
  (compile -s -O2 cairo.image.import.scm)
  (compile -s -O2 cairo.xlib.import.scm))

(install-extension 
 'cairo
 '("cairo.so" "cairo.import.so" "cairo.o" "cairo.types"
   "cairo.svg.so" "cairo.svg.import.so" "cairo.svg.o"
   "cairo.image.so" "cairo.image.import.so" "cairo.image.o"
   "cairo.xlib.so" "cairo.xlib.import.so" "cairo.xlib.o")
 '((version 1.0.0)))
